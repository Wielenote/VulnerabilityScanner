#include "mainwindow.h"
#include "ui_mainwindow.h"
#include <JsonParser.h>
#include <adddevice_dialog.h>
#include <qtreewidget.h>
#include <QTreeWidgetItem>


void MainWindow::ShowDevices()
{
    ui->listWidget->clear();
    QString path = "/home/wielenote/Documents/devices.json";
    auto file = JsonFile::ReadFile(path);
    auto doc = QJsonDocument::fromJson(file);
    auto doc_object = doc.object();

    auto list_of_devices = doc_object.keys();
    ui->listWidget->addItems(list_of_devices);
}
MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , ui(new Ui::MainWindow)
{
    ui->setupUi(this);
    ui->tabWidget->setCurrentIndex(0);

    ShowDevices();
}

MainWindow::~MainWindow()
{
    delete ui;
}


void MainWindow::onResult(QNetworkReply *reply)
{
    auto er = reply->error();
    if(er == QNetworkReply::NoError)
    {
        QJsonDocument document = QJsonDocument::fromJson(reply->readAll());
        auto Object = document.object().value("cves");
        auto array = Object.toArray();
        auto currentObject = array.at(0).toObject();
        for(const auto& item : currentObject.keys())
        {

            qDebug() << item <<'-' << currentObject.value(item).toVariant().toString();
        }
    }
    reply->deleteLater();
}

void MainWindow::on_add_button_clicked()
{
    AddDevice_dialog dialog(this);
    this->hide();
    dialog.exec();
}


void MainWindow::on_tabWidget_currentChanged(int index)
{
    if(index == 1)
    {
        ui->treeWidget->setColumnCount(1);
        auto a = JsonFile();
        auto val = a.GetVulnerabilities();
        QTreeWidgetItem *packge_root = new QTreeWidgetItem(ui->treeWidget);
        packge_root->setText(0,"sudo");
        for (const auto& item : val) // Потом добавить для всех пакетов
        {
            QTreeWidgetItem *cve_root = new QTreeWidgetItem();
            QTreeWidgetItem *cve_info_root1 = new QTreeWidgetItem();
            QTreeWidgetItem *cve_info_root2 = new QTreeWidgetItem();
            std::stringstream ss;
            ss << std::fixed << std::setprecision(2) << item.GetCVSS();


            cve_root->setText(0, QString::fromStdString(item.GetCVE_ID()));
            cve_info_root1->setText(0, "Status: " + QString::fromStdString(item.GetStatus()));
            cve_info_root2->setText(0, "CVSS3: " + QString::fromStdString(ss.str()));


            cve_root->addChild(cve_info_root1);
            cve_root->addChild(cve_info_root2);


            packge_root->addChild(cve_root);

        }
        ui->treeWidget->addTopLevelItem(packge_root);
    }
    else
    {
        ui->treeWidget->clear();
    }
}

