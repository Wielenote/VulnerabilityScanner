#!/bin/bash
_pwd=$(pwd)
i=0
IFS=';' read -r OS OS_VERSION OS_CODENAME < $_pwd/script_result_ZOS.txt
mkdir -p $_pwd/vulnerabilities
while IFS=' ' read -r package version
do
    offset=0
    if [[ $i -ne 0 ]]; then
        j=1
        request="https://ubuntu.com/security/cves.json?package=$package&version=$OS_CODENAME&limit=100&order=descending&sort_by=published"
        echo "$package-$j"
        curl -o $_pwd/vulnerabilities/$package-$j.json -s -X 'GET' \
        "$request" \
        -H 'accept: application/json'
        total_results=$(jq .total_results $_pwd/vulnerabilities/$package-$j.json)
        let "j = $j + 1"
        let "total_results = $total_results - 100"
        while (( total_results > 0 ))
        do
                let "offset=$offset + 100"
                let "total_results = $total_results - 100"
                request="https://ubuntu.com/security/cves.json?package=$package&version=$OS_CODENAME&offset=$offset&limit=100&order=descending&sort_by=published"
                curl -o $_pwd/vulnerabilities/$package-$j.json -s -X 'GET' \
                "$request" \
                -H 'accept: application/json'
                echo $package-$j
                let "j = $j + 1"
        done
    fi
let "i = $i + 1"
done < $_pwd/script_result_ZOS.txt

