#!/bin/bash

pass=$1
name=$2
ip=$3
port=${4:-22}

remote_home="$(sshpass -p "$pass" ssh -o "StrictHostKeyChecking=no" $name@$ip echo '$HOME')"
sshpass -p "$pass" ssh -o "StrictHostKeyChecking=no" $name@$ip rm -rf $remote_home/Documents/script_ZOS.sh
sshpass -p "$pass" scp -o "StrictHostKeyChecking=no" -P $port $PWD/script_ZOS.sh $name@$ip:$remote_home/Documents/script_ZOS.sh
sshpass -p "$pass" ssh -o "StrictHostKeyChecking=no" $name@$ip chmod +x $remote_home/Documents/script_ZOS.sh
sshpass -p "$pass" ssh -o "StrictHostKeyChecking=no" $name@$ip $remote_home/Documents/script_ZOS.sh > $PWD/script_result_ZOS.txt

#Move to another script
i=0
IFS=';' read -r OS OS_VERSION OS_CODENAME < $PWD/script_result_ZOS.txt
while IFS=' ' read -r package version
do
    if [[ $i -ne 0 ]]; then
	request="https://ubuntu.com/security/cves.json?package=$package&version=$OS_CODENAME&limit=100&order=descending&sort_by=published"
	echo "$package $version"
	curl -s -X 'GET' \
	"$request" \
	-H 'accept: application/json' > ./vulnerabilities/$package.json
    fi
let "i = $i + 1"
done < $PWD/script_result_ZOS.txt

